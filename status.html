<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>K0MRAID Downloader — Status</title>
<style>
:root {
  color-scheme: light;
}
*,
*::before,
*::after {
  box-sizing: border-box;
}
body {
  margin: 0;
  font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background: #fff;
  color: #000;
}
a {
  color: #000;
  text-decoration: none;
}
a:hover,
button:hover {
  background: #000;
  color: #fff;
}
header {
  border-bottom: 1px solid #000;
  padding: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fff;
}
.brand {
  font-weight: 600;
  letter-spacing: 0.02em;
}
nav {
  display: flex;
  gap: 12px;
}
nav a {
  padding: 8px 12px;
  border: 1px solid #000;
  border-radius: 3px;
}
main {
  max-width: 600px;
  margin: 0 auto;
  padding: 32px 20px 80px;
}
h1 {
  margin: 0 0 8px;
  font-size: 1.875rem;
  line-height: 1.1;
}
.subtitle {
  margin: 0 0 28px;
  font-size: 0.95rem;
  line-height: 1.4;
}
.toolbar {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  border: 1px solid #000;
  border-radius: 3px;
  padding: 12px;
  margin-bottom: 24px;
}
button {
  cursor: pointer;
  padding: 10px 18px;
  border: 1px solid #000;
  border-radius: 3px;
  background: #fff;
  color: #000;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
button:focus-visible {
  outline: 2px solid #000;
  outline-offset: 2px;
}
.summary {
  border: 1px solid #000;
  border-radius: 3px;
  padding: 16px;
  margin-bottom: 24px;
  display: grid;
  gap: 12px;
}
.summary span {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.summary strong {
  font-size: 1.25rem;
}
.jobs {
  border: 1px solid #000;
  border-radius: 3px;
  padding: 16px;
}
.jobs h2 {
  margin: 0 0 16px;
  font-size: 1.05rem;
}
.job-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: grid;
  gap: 12px;
}
.job {
  border: 1px solid #000;
  border-radius: 3px;
  padding: 12px;
  display: grid;
  gap: 8px;
}
.job header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  border: none;
  padding: 0;
  background: transparent;
}
.job header h3 {
  margin: 0;
  font-size: 1rem;
}
.job header span {
  font-size: 0.78rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.job p {
  margin: 0;
  font-size: 0.85rem;
  word-break: break-word;
}
.empty-state {
  border: 1px dashed #000;
  border-radius: 3px;
  padding: 32px;
  text-align: center;
  font-size: 0.9rem;
}
@media (min-width: 640px) {
  header {
    padding: 20px 32px;
  }
  main {
    padding: 48px 20px 96px;
  }
  .summary {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}
</style>
</head>
<body>
<header>
  <div class="brand">K0MRAID Downloader</div>
  <nav>
    <a href="index.html">Home</a>
    <a href="status.html">Status</a>
  </nav>
</header>
<main>
  <h1>Download Status</h1>
  <p class="subtitle">Monitor active and recent jobs from the FastAPI backend.</p>
  <div class="toolbar">
    <button id="refresh">Refresh</button>
    <button id="auto-toggle" data-active="true">Pause Auto Refresh</button>
  </div>
  <section class="summary" aria-live="polite">
    <div>
      <span>Active</span>
      <strong id="count-active">0</strong>
    </div>
    <div>
      <span>Queued</span>
      <strong id="count-queued">0</strong>
    </div>
    <div>
      <span>Completed</span>
      <strong id="count-complete">0</strong>
    </div>
  </section>
  <section class="jobs">
    <h2>Recent Jobs</h2>
    <div id="jobs-container" class="empty-state">No jobs available.</div>
  </section>
</main>
<script>
(function () {
  const refreshButton = document.getElementById('refresh');
  const autoToggle = document.getElementById('auto-toggle');
  const activeCount = document.getElementById('count-active');
  const queuedCount = document.getElementById('count-queued');
  const completeCount = document.getElementById('count-complete');
  const jobsContainer = document.getElementById('jobs-container');
  const AUTO_INTERVAL = 8000;
  let timer = null;

  function parseJobs(data) {
    return Array.isArray(data) ? data : [];
  }

  function renderJobs(list) {
    if (!list.length) {
      jobsContainer.className = 'empty-state';
      jobsContainer.textContent = 'No jobs available.';
      return;
    }
    const fragment = document.createElement('ul');
    fragment.className = 'job-list';
    list.forEach(function (job) {
      const item = document.createElement('li');
      const header = document.createElement('header');
      const title = document.createElement('h3');
      const badge = document.createElement('span');
      const url = document.createElement('p');
      const meta = document.createElement('p');

      item.className = 'job';
      title.textContent = (job.type || 'Job').toUpperCase();
      badge.textContent = (job.status || 'UNKNOWN').toUpperCase();
      url.textContent = job.url || 'No source URL';
      meta.textContent = job.updated_at ? 'Updated: ' + new Date(job.updated_at).toLocaleTimeString() : 'Updated just now';

      header.appendChild(title);
      header.appendChild(badge);
      item.appendChild(header);
      item.appendChild(url);
      item.appendChild(meta);

      fragment.appendChild(item);
    });
    jobsContainer.className = '';
    jobsContainer.innerHTML = '';
    jobsContainer.appendChild(fragment);
  }

  function updateSummary(list) {
    let active = 0;
    let queued = 0;
    let complete = 0;
    list.forEach(function (job) {
      const status = (job.status || '').toLowerCase();
      if (status === 'completed' || status === 'success') {
        complete += 1;
      } else if (status === 'queued') {
        queued += 1;
      } else if (status) {
        active += 1;
      }
    });
    activeCount.textContent = active;
    queuedCount.textContent = queued;
    completeCount.textContent = complete;
  }

  function fetchJobs() {
    refreshButton.disabled = true;
    refreshButton.textContent = 'Refreshing…';
    fetch('/download/jobs')
      .then(function (response) {
        if (!response.ok) {
          throw new Error('Failed to load jobs');
        }
        return response.json();
      })
      .then(function (data) {
        const jobs = parseJobs(data);
        renderJobs(jobs);
        updateSummary(jobs);
      })
      .catch(function () {
        jobsContainer.className = 'empty-state';
        jobsContainer.textContent = 'Unable to reach the backend.';
      })
      .finally(function () {
        refreshButton.disabled = false;
        refreshButton.textContent = 'Refresh';
      });
  }

  function startAutoRefresh() {
    stopAutoRefresh();
    timer = window.setInterval(fetchJobs, AUTO_INTERVAL);
  }

  function stopAutoRefresh() {
    if (timer) {
      window.clearInterval(timer);
      timer = null;
    }
  }

  refreshButton.addEventListener('click', function () {
    fetchJobs();
  });

  autoToggle.addEventListener('click', function () {
    const active = autoToggle.dataset.active === 'true';
    if (active) {
      stopAutoRefresh();
      autoToggle.dataset.active = 'false';
      autoToggle.textContent = 'Resume Auto Refresh';
    } else {
      autoToggle.dataset.active = 'true';
      autoToggle.textContent = 'Pause Auto Refresh';
      startAutoRefresh();
    }
  });

  fetchJobs();
  startAutoRefresh();
})();
</script>
</body>
</html>
